(function () {
    tinymce.create('tinymce.plugins.ImageUploadPlugin', {
        init: function (ed, url) {
            url = tinyMCE.activeEditor.getParam('imageupload_rel') || url;
            // var imageUploadUrl = '/item/upload_image.html'; //tinyMCE.activeEditor.getParam('imageupload_url');
            var imageUploadUrl = 'http://yueqingfang.cn/markdown/php/imgUpload_batch.php'; //tinyMCE.activeEditor.getParam('imageupload_url');
            // var imageUploadUrl = 'http://localhost/php/imgUpload22_batch.php'; //tinyMCE.activeEditor.getParam('imageupload_url');
            var head = document.getElementsByTagName('body')[0];
            var css = document.createElement('link');
            css.type = 'text/css';
            css.rel = 'stylesheet';
            css.href = url + '/css/style.css';
            head.appendChild(css);

            // Register commands
            ed.addCommand('mceImageUpload', function () {
                $('#image_upload_type').val('tinymce');
                $('body').append('<div class="imageUploadBg"></div>');

                var showImageUploadError = function (msg) {
                    $('.imageUploadError').html(msg).show();
                    removeForeground();
                };

                var removeForeground = function () {
                    $('.imageUploadFg').remove();
                    $('.imageUploadFgLoading').remove();
                };

                var removeBackground = function () {
                    $('.imageUploadBg').remove();
                    $('.imageUploadContainer').remove();
                };

                var container = '\
                    <div class="imageUploadContainer mce-container mce-panel mce-window mce-in">\
                        <div class="imageUploadContainerInner">\
                            <div class="mce-window-head">\
                                <div class="mce-title">图片上传</div>\
                                <button type="button" class="mce-close">×</button>\
                            </div>\
                            <form action="' + imageUploadUrl + '" method="POST"  enctype="multipart/form-data" id="uploadImageForm">\
                            <div>\
                                <label class="labelDis">\
                                    <input type="checkbox" class="checkScale" name="checkScale" style="vertical-align:middle; margin:-3px 4px 0 0"/>裁剪图片\
                                    <input type="hidden" class="eduiScaleCheckbox" name="eduiScale" />\
                                </label>\
                            </div>\
                            <div style="height: 50px;" class="mce-container imageUploadFormContainer" hidefocus="1" tabindex="-1">\
                                <div class="mce-container-body inputFile">\
                                    <label class="labelDis">\
                                    选择图片\
                                    <input multiple="multiple" type="file" name="img[]" id="image-upload-area" class="mce-textbox mce-placeholder" hidefocus="true" style="width: 258px;">\
                                    </label>\
                                </div>\
                                <p class="imageUploadError" style="margin-top: -13px;"></p>\
                            </div>\
                            <div>\
                                <label class="labelDis">\
                                    <input class="jumpIsTrue" type="checkbox" style="vertical-align:middle; margin:-3px 4px 0 0"/>跳转地址\
                                    <input type="text" class="jumpInput" placeholder="请输入跳转地址"  />\
                                </label>\
                            </div>\
                            <div>\
                                <label class="labelDis">\
                                    <input class="goodJumpIsTrue" type="checkbox" style="vertical-align:middle; margin:-3px 4px 0 0"/>商品跳转\
                                    <input type="text" class="goodJumpInput" placeholder="请输入商品ID" />\
                                </label>\
                            </div>\
                            </form>\
                            <div class="">\
                                </div>\
                            <div class="imageUploadConfirmCase mce-panel">\
                                <div class="mce-btn mce-primary">\
                                    <button role="presentation" class="imageUploadSubmit">上传</button>\
                                </div>\
                                <div class="mce-btn">\
                                    <button role="presentation" class="imageUploadClose">放弃</button>\
                                </div>\
                            </div>\
                        </div>\
                    </div>\
                ';
                //var container = '\
                //    <div class="imageUploadContainer mce-container mce-panel mce-window">\
                //        <div class="imageUploadContainerInner">\
                //            <div class="mce-window-head">\
                //                <div class="mce-title">图片上传</div>\
                //                <button type="button" class="mce-close">×</button>\
                //            </div>\
                //            <form action="' + imageUploadUrl + '" method="POST"  enctype="multipart/form-data" id="uploadImageForm">\
                //            <div class="mce-container imageUploadFormContainer" hidefocus="1" tabindex="-1">\
                //                <div class="mce-container-body">\
                //                    <label for="image-upload-area">选择图片</label>\
                //                    <input type="file" name="file" id="image-upload-area" class="mce-textbox mce-placeholder" hidefocus="true" style="width: 258px;">\
                //                </div>\
                //                <p class="imageUploadError"></p>\
                //            </div>\
                //            </form>\
                //            <div class="">\
                //                    <label>商品id</label><input type="text" class="itemId" />\
                //                </div>\
                //            <div class="imageUploadConfirmCase mce-panel">\
                //                <div class="mce-btn mce-primary">\
                //                    <button role="presentation" class="imageUploadSubmit">上传</button>\
                //                </div>\
                //                <div class="mce-btn">\
                //                    <button role="presentation" class="imageUploadClose">放弃</button>\
                //                </div>\
                //            </div>\
                //        </div>\
                //    </div>\
                //';

                $('body').append(container);


                $('.imageUploadBg, .imageUploadContainer .imageUploadClose, .mce-close').on('click', function () {
                    removeForeground();
                    removeBackground();
                });

                var submitUpload = function () {
                    $('#uploadImageForm').ajaxSubmit({
                        dataType: 'json',
                        headers: {PAJAX: "true"},
                        success: function (response) {
                            var jumpIsTrue = $(".jumpIsTrue")[0].checked;
                            var jumpAddress = $('.jumpInput')[0].value;
                            var goodJumpIsTrue = $('.goodJumpIsTrue')[0].checked;
                            var goodJumpInput = $(".goodJumpInput")[0].value;
                            if (jumpIsTrue && goodJumpInput) {
                                return;
                            }
                            if (response.code == "success") {
                                getImage(function(width,height,size) {
                                    var imgClass = "insertimg";
                                    var pStyle = "";
                                    if(width > 300) {

                                    }else {
                                        imgClass = "insertSmallimg";
                                        pStyle = "text-align: center;";
                                    }
                                    var imgTpl = [];
                                    if (jumpIsTrue) {
                                        for (var i = 0, len = response.model.length; i < len; i++) {
                                            var tpl = '<p style="'+pStyle+'"><a href="' + jumpAddress + '"><img src="%s" class="'+ imgClass +'" data-role="jumpImg" /></a></p>';
                                            imgTpl.push(tpl.replace('%s', response.model[i]));
                                        }
                                    } else if (goodJumpIsTrue) {
                                        for (var i = 0, len = response.model.length; i < len; i++) {
                                            var tpl = '<p style="'+pStyle+'"><a href="http://m.zhefengle.cn/#/detail&' + goodJumpInput + '&" class="siteBox item-detailLink"><img src="%s" class="'+ imgClass +'" data-role="jumpImg" /></a></p>';
                                            imgTpl.push(tpl.replace('%s', response.model[i]));
                                        }
                                    } else {
                                        for (var i = 0, len = response.model.length; i < len; i++) {
                                            var tpl = '<p style="'+pStyle+'"><img src="%s" class="'+ imgClass +'" /></p>';
                                            imgTpl.push(tpl.replace('%s', response.model[i]));
                                        }
                                    }
                                    ed.insertContent(imgTpl.join(''));
                                    // var tpl = '<p><img src="%s" class="insertimg" /></p>';
                                    // console.log($(".itemId").val())
                                    // ed.insertContent(tpl.replace('%s', response.model[0]));

                                    ed.focus();
                                    removeForeground();
                                    removeBackground();
                                });
                            } else {
                                removeForeground();
                                removeBackground();
                                showImageUploadError('上传错误：2');
                                // alert(response.message);
                                var message = $('<div class="ui-notification error clickable" style="width: 280px;height: 40px;position: fixed; right: 10px; top: 20px; opacity: 1;">' +
                                    '<div class="message">' + response.message + '</div>' +
                                    '</div>');
                                $('body').append(message);
                                message.stop(true, true);
                                message.animate({
                                    top: 20,
                                    opacity: 1
                                }, 1000, function () {
                                    message.animate({
                                        top: 40,
                                        opacity: 0
                                    }, 1000, function () {
                                        message.remove();
                                    })
                                })
                            }
                            //if (typeof response != "object" || response == null || typeof response.error == 'undefined') {
                            //    removeForeground();
                            //    showImageUploadError('上传出错：1');
                            //}
                            //else {
                            //    if (response.error != false) {
                            //        switch (response.error) {
                            //            case ("filetype"):
                            //                showImageUploadError('请选择图片格式的文件上传');
                            //                break;
                            //            default:
                            //                showImageUploadError('未知错误：1');
                            //                break;
                            //        }
                            //    }
                            //    else {
                            //        if (typeof response.path != 'undefined') {
                            //            var tpl = '<img src="%s" />';
                            //            ed.insertContent(tpl.replace('%s', response.path));
                            //            ed.focus();
                            //            removeForeground();
                            //            removeBackground();
                            //        } else {
                            //            showImageUploadError('未知错误：2');
                            //        }
                            //    }
                            //}
                        },
                        error: function (response) {
                            removeForeground();
                            removeBackground();
                            showImageUploadError('上传错误：2');
                            // alert('网络出错');
                            var message = $('<div class="ui-notification error clickable" style="width: 280px;height: 40px;position: fixed; right: 10px; top: 20px; opacity: 1;">' +
                                '<div class="message">网络出错</div>' +
                                '</div>');
                            $('body').append(message);
                            message.stop(true, true);
                            message.animate({
                                top: 20,
                                opacity: 1
                            }, 1000, function () {
                                message.animate({
                                    top: 40,
                                    opacity: 0
                                }, 1000, function () {
                                    message.remove();
                                })
                            })
                        }
                    });
                }


                $('#uploadImageForm').ajaxForm(function(response) {
                    response = JSON.parse(response);
                    var jumpIsTrue = $(".jumpIsTrue")[0].checked;
                    var jumpAddress = $('.jumpInput')[0].value;
                    var goodJumpIsTrue = $('.goodJumpIsTrue')[0].checked;
                    var goodJumpInput = $(".goodJumpInput")[0].value;
                    if (jumpIsTrue && goodJumpInput) {
                        return;
                    }
                    if (response.code == "success") {
                        getImage(function(width,height,size) {
                            var imgClass = "insertimg";
                            var pStyle = "";
                            if(width > 300) {

                            }else {
                                imgClass = "insertSmallimg";
                                pStyle = "text-align: center;";
                            }
                            var imgTpl = [];
                            if (jumpIsTrue) {
                                for (var i = 0, len = response.model.length; i < len; i++) {
                                    var tpl = '<p style="'+pStyle+'"><a href="' + jumpAddress + '"><img src="%s" class="'+ imgClass +'" data-role="jumpImg" /></a></p>';
                                    imgTpl.push(tpl.replace('%s', response.model[i]));
                                }
                            } else if (goodJumpIsTrue) {
                                for (var i = 0, len = response.model.length; i < len; i++) {
                                    var tpl = '<p style="'+pStyle+'"><a href="http://m.zhefengle.cn/#/detail&' + goodJumpInput + '&" class="siteBox item-detailLink"><img src="%s" class="'+ imgClass +'" data-role="jumpImg" /></a></p>';
                                    imgTpl.push(tpl.replace('%s', response.model[i]));
                                }
                            } else {
                                for (var i = 0, len = response.model.length; i < len; i++) {
                                    var tpl = '<p style="'+pStyle+'"><img src="%s" class="'+ imgClass +'" /></p>';
                                    imgTpl.push(tpl.replace('%s', response.model[i]));
                                }
                            }
                            ed.insertContent(imgTpl.join(''));
                            // var tpl = '<p><img src="%s" class="insertimg" /></p>';
                            // console.log($(".itemId").val())
                            // ed.insertContent(tpl.replace('%s', response.model[0]));

                            ed.focus();
                            removeForeground();
                            removeBackground();
                        });
                    } else {
                        removeForeground();
                        removeBackground();
                        showImageUploadError('上传错误：2');
                        // alert(response.message);
                        var message = $('<div class="ui-notification error clickable" style="width: 280px;height: 40px;position: fixed; right: 10px; top: 20px; opacity: 1;">' +
                            '<div class="message">' + response.message + '</div>' +
                            '</div>');
                        $('body').append(message);
                        message.stop(true, true);
                        message.animate({
                            top: 20,
                            opacity: 1
                        }, 1000, function () {
                            message.animate({
                                top: 40,
                                opacity: 0
                            }, 1000, function () {
                                message.remove();
                            })
                        })
                    }
                });
                $('#uploadImageForm').submit(function () {
                    // submitUpload();

                    // return false;
                });

                $('.imageUploadSubmit').on('click', function () {

                    $('.imageUploadError').html('').hide();
                    var jumpIsTrue = $(".jumpIsTrue")[0].checked;
                    var jumpAddress = $('.jumpInput')[0].value;
                    var goodJumpIsTrue = $('.goodJumpIsTrue')[0].checked;
                    var goodJumpInput = $(".goodJumpInput")[0].value;
                    if (jumpIsTrue && goodJumpIsTrue) {
                        showImageUploadError('跳转地址和商品跳转不可以一起选择');
                        return;
                    } else if (jumpIsTrue && !jumpAddress) {
                        showImageUploadError('跳转地址不能为空');
                        return;
                    } else if (goodJumpIsTrue && !goodJumpInput) {
                        showImageUploadError('商品ID不能为空');
                        return;
                    } else if (goodJumpIsTrue && goodJumpInput) {
                        var datas = {
                            data: {
                                ids: goodJumpInput
                            }
                        }

                        function coAsync(ed) {
                            return {
                                next: function (ed) {
                                    console.log("test");
                                    init(ed);
                                },
                                reject: function (msg) {
                                    alert(msg || '商品错误');
                                }
                            }
                        }

                        ed.settings.recommendList.getitemdetailCallback(datas, coAsync(ed));
                        return;
                    }

                    // removeForeground();
                    // removeBackground();
                    function init(ed) {

                        if ($('#image-upload-area').val() != '') {
                            $('body').append('<div class="imageUploadFg"></div>');
                            $('body').append('<div class="imageUploadFgLoading"></div>');
                            console.log($(".checkScale").is(':checked'))
                            if ($(".checkScale").is(':checked')) {
                                $(".eduiScaleCheckbox").val("1");
                            } else {
                                $(".eduiScaleCheckbox").val("0");

                            }
                            $('#uploadImageForm').submit();
                        } else {
                            showImageUploadError('请选择图片格式的文件上传');
                        }
                    }

                    init();

                });
            });

            // Register buttons
            ed.addButton('imageupload', {
                title: '添加本地图片',
                cmd: 'mceImageUpload',
                image: url + '/img/icon.png'
            });
        },

        getInfo: function () {
            return {
                longname: 'Image Upload',
                author: 'BoxUK',
                authorurl: 'https://github.com/boxuk/tinymce-imageupload',
                infourl: 'https://github.com/boxuk/tinymce-imageupload/blob/master/README.md',
                version: '1.0.0'
            };
        },
    });

    function getImage(callback) {
        //读取图片数据
        var f = document.getElementById("image-upload-area").files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
            var data = e.target.result;
            //加载图片获取图片真实宽度和高度
            var image = new Image();
            image.onload=function(){
                var width = image.width;
                var height = image.height;
                // alert(width+'======'+height+"====="+f.size);
                callback(width,height,f.size);
            };
            image.src= data;
        };
        reader.readAsDataURL(f);
    };

    tinymce.PluginManager.add('imageupload', tinymce.plugins.ImageUploadPlugin);
})();
